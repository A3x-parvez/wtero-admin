{% extends "base.html" %}
{% block content %}
<h1>Users (Admin)</h1>

<div id="adminSection" style="display:none;">
  <form id="addUserForm" class="form inline">
    <input name="username" placeholder="username" required />
    <input name="password" placeholder="password" required type="password" />
    <select name="role">
      <option value="user">user</option>
      <option value="admin">admin</option>
    </select>
    <button class="btn-primary" type="submit">Add</button>
  </form>

  <p id="addError" style="color:red; display:none;"></p>

  <table class="table mt">
    <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
    <tbody id="usersBody"></tbody>
  </table>
</div>

<p id="notAdminMsg" style="color:red; display:none;">
  ❌ You must be an admin to manage users.
</p>
{% endblock %}

{% block scripts %}
<script>
  ensureAuth();

  async function getCurrentUser() {
    const res = await authFetch("/auth/me");
    if (!res.ok) return null;
    return await res.json();
  }

  async function loadUsers() {
    // 🔧 Removed `?limit=200` to avoid 422 error
    const res = await authFetch("/users");
    if (!res.ok) {
      alert("❌ You must be admin to view users.");
      return;
    }
    const users = await res.json();
    const body = document.getElementById("usersBody");
    body.innerHTML = "";
    users.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>${u.role}</td>
        <td>
          ${u.username !== "admin" ? `<button class="btn-danger" data-del="${u.username}">Delete</button>` : ""}
        </td>
      `;
      body.appendChild(tr);
    });
  }

  // permanent delete listener
  document.getElementById("usersBody").addEventListener("click", async (e) => {
    const username = e.target.dataset.del;
    if (!username) return;
    if (confirm("Delete user " + username + "?")) {
      await authFetch(`/users/${username}`, { method: "DELETE" });
      loadUsers();
    }
  });

  async function init() {
    const user = await getCurrentUser();
    if (!user) {
      window.location.href = "/login";
      return;
    }

    if (user.role === "admin") {
      document.getElementById("adminSection").style.display = "block";
      loadUsers();
    } else {
      document.getElementById("notAdminMsg").style.display = "block";
    }
  }

  document.getElementById("addUserForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const errEl = document.getElementById("addError");
    errEl.style.display = "none";

    const form = new FormData(e.currentTarget);
    const username = form.get("username");
    const password = form.get("password");
    const role = form.get("role");

    const res = await authFetch("/users/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password, role })
    });

    if (!res.ok) { 
      const err = await res.json().catch(() => ({}));
      errEl.textContent = "❌ Add failed: " + (err.detail || "unknown error");
      errEl.style.display = "block";
      return; 
    }

    e.currentTarget.reset();
    loadUsers();  // refresh list
  });

  init();
</script>
{% endblock %}
