{% extends "base.html" %}
{% block content %}
<h1>Users (Admin)</h1>

<div id="adminSection" style="display:none;">
  <form id="addUserForm" class="form inline">
    <input name="username" placeholder="username" required />
    <input name="password" placeholder="password" required type="password" />
    <select name="role">
      <option value="user">user</option>
      <option value="admin">admin</option>
    </select>
    <button class="btn-primary" type="submit">Add User</button>
  </form>

  <table class="table mt">
    <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
    <tbody id="usersBody"></tbody>
  </table>
</div>
<p id="notAdminMsg" style="color:red; display:none;">
  ‚ùå You must be an admin to manage users.
</p>
{% endblock %}

{% block scripts %}
<script>
  ensureAuth();

  async function getCurrentUser() {
    try {
      const res = await authFetch("/auth/me");
      if (!res.ok) return null;
      return await res.json();
    } catch {
      return null;
    }
  }

  async function loadUsers() {
    try {
      const res = await authFetch("/users", { cache: "no-cache" });
      if (!res.ok) {
        showToast("You must be an admin to view users.", "error");
        return;
      }
      const users = await res.json();
      const body = document.getElementById("usersBody");
      body.innerHTML = "";
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>
            ${u.username !== "admin" ? `<button class="btn-danger" data-del="${u.username}">Delete</button>` : ""}
          </td>
        `;
        body.appendChild(tr);
      });
    } catch {
      showToast("Failed to load users.", "error");
    }
  }

  document.getElementById("usersBody").addEventListener("click", async (e) => {
    const username = e.target.dataset.del;
    if (!username) return;
    const confirmed = await showConfirm("Delete User?", `Are you sure you want to delete user '${username}'?`);
    if (confirmed) {
      await authFetch(`/users/${username}`, { method: "DELETE" });
      showToast("User deleted successfully!");
      await loadUsers();
    }
  });

  async function init() {
    const user = await getCurrentUser();
    if (!user) {
      window.location.href = "/ui/login";
      return;
    }

    if (user.role === "admin") {
      document.getElementById("adminSection").style.display = "block";
      await loadUsers();
    } else {
      document.getElementById("notAdminMsg").style.display = "block";
    }
  }

  document.getElementById("addUserForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const formElement = document.getElementById("addUserForm");
    const formData = new FormData(formElement);
    const username = formData.get("username");
    const password = formData.get("password");
    const role = formData.get("role");

    try {
      const res = await authFetch("/users/add", {
        method: "POST",
        body: { username, password, role }
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || "Unknown error");
      }

      showToast("User added successfully!");
      formElement.reset(); 
      await loadUsers();

    } catch (error) {
      showToast(`Add failed: ${error.message}`, "error");
    }
  });

  init();
</script>
{% endblock %}