{% extends "base.html" %}
{% block content %}
<div class="toolbar">
  <h1>Products</h1>
  <button id="openCreate" class="btn-primary">+ New Product</button>
</div>

<table class="table" id="productsTable">
  <thead>
    <tr>
      <th style="width: 20%;">Title</th>
      <th style="width: 15%;">Category</th>
      <th>Tech</th>
      <th style="width: 10%;">Coming Soon</th>
      <th style="width: 10%;">Links</th>
      <th style="width: 10%;">Image</th>
      <th style="width: 15%;">Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<dialog id="prodModal">
  <form id="prodForm" method="dialog" class="form">
    <h3 id="prodTitle">Create Product</h3>
    <input type="hidden" name="id" />
    <label>Title</label><input name="title" required />
    <label>Category</label><input name="category" required />
    <label>Description</label><textarea name="description" rows="3" required></textarea>
    <label>Technologies (comma-separated)</label><input name="technologies" placeholder='FastAPI, MongoDB, Vue' />
    <label>GitHub Link</label><input name="githubLink" type="url" />
    <label>Live Link</label><input name="liveLink" type="url" />
    <label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" name="comingSoon" /> Coming Soon</label>
    <label>Image</label><input type="file" name="image" accept="image/*" />
    <div class="actions">
      <button class="btn" type="button" id="prodCancel">Cancel</button>
      <button class="btn-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
  ensureAuth();
  const tbody = document.querySelector("#productsTable tbody");
  const modal = document.getElementById("prodModal");
  const form = document.getElementById("prodForm");
  const openBtn = document.getElementById("openCreate");
  const cancelBtn = document.getElementById("prodCancel");
  const titleEl = document.getElementById("prodTitle");

  const githubIcon = `<svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>`;
  const liveLinkIcon = `<svg viewBox="0 0 24 24"><path d="M10.59 13.41c.41.39.41 1.03 0 1.42-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0 5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.982 2.982 0 0 0 0-4.24 2.982 2.982 0 0 0-4.24 0l-3.53 3.53a2.982 2.982 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0 5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.982 2.982 0 0 0 0 4.24 2.982 2.982 0 0 0 4.24 0l3.53-3.53a2.982 2.982 0 0 0 0-4.24z"/></svg>`;

  async function loadProducts() {
    const res = await authFetch("/products?limit=100");
    const data = await res.json();
    tbody.innerHTML = "";
    data.forEach(p => {
      const tech = Array.isArray(p.technologies) ? p.technologies.join(", ") : "";
      const img = p.image ? `<img class="thumb" src="data:image/*;base64,${p.image}"/>` : "";
      
      let linksHTML = '<div class="links-container">';
      if (p.githubLink) {
        linksHTML += `<a href="${p.githubLink}" target="_blank" class="link-btn" title="GitHub">${githubIcon}</a>`;
      }
      if (p.liveLink) {
        linksHTML += `<a href="${p.liveLink}" target="_blank" class="link-btn" title="Live Link">${liveLinkIcon}</a>`;
      }
      linksHTML += '</div>';

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="truncate" title="${p.title}">${p.title}</td>
        <td class="truncate" title="${p.category}">${p.category}</td>
        <td class="truncate" title="${tech}">${tech}</td>
        <td>${p.comingSoon ? "Yes" : "No"}</td>
        <td>${linksHTML}</td>
        <td>${img}</td>
        <td>
          <button class="btn" data-edit="${p.id}">Edit</button>
          <button class="btn-danger" data-del="${p.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  openBtn.onclick = () => {
    form.reset();
    form.id.value = "";
    titleEl.textContent = "Create Product";
    modal.showModal();
  };
  cancelBtn.onclick = () => modal.close();

  tbody.addEventListener("click", async (e) => {
    const targetButton = e.target.closest('button[data-edit], button[data-del]');
    if (!targetButton) return;

    const id = targetButton.dataset.edit || targetButton.dataset.del;

    if (targetButton.dataset.edit) {
      const r = await (await authFetch(`/products/${id}`)).json();
      form.id.value = r.id;
      form.title.value = r.title;
      form.category.value = r.category;
      form.description.value = r.description;
      form.technologies.value = (r.technologies || []).join(", ");
      form.githubLink.value = r.githubLink || "";
      form.liveLink.value = r.liveLink || "";
      form.comingSoon.checked = !!r.comingSoon;
      titleEl.textContent = "Edit Product";
      modal.showModal();
    }

    if (targetButton.dataset.del) {
      const confirmed = await showConfirm("Delete Product?", "This action cannot be undone.");
      if (confirmed) {
        await authFetch(`/products/${id}`, { method: "DELETE" });
        showToast("Product deleted!");
        loadProducts();
      }
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const id = fd.get("id");

    if (fd.get("comingSoon") === "on") fd.set("comingSoon", "true");
    else fd.set("comingSoon", "false");

    if (!fd.get("image") || (fd.get("image") instanceof File && !fd.get("image").name)) {
      fd.delete("image");
    }

    const url = id ? `/products/${id}` : `/products`;
    const method = id ? "PUT" : "POST";
    const res = await authFetch(url, { method, body: fd });
    if (!res.ok) {
      showToast("Save failed", "error");
      return;
    }
    showToast("Product saved successfully!");
    modal.close();
    loadProducts();
  });

  loadProducts();
</script>
{% endblock %}