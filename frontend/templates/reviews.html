{% extends "base.html" %}
{% block content %}
<div class="toolbar">
  <h1>Reviews</h1>
  <button id="openCreate" class="btn-primary">+ New Review</button>
</div>

<table class="table" id="reviewsTable">
  <thead>
    <tr>
      <th>Name</th><th>Company</th><th>Role</th><th>Rating</th><th>Text</th><th>Avatar</th><th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Create/Edit Modal -->
<dialog id="reviewModal">
  <form id="reviewForm" method="dialog" class="form">
    <h3 id="modalTitle">Create Review</h3>
    <input type="hidden" name="id" />
    <label>Name</label><input name="name" required />
    <label>Company</label><input name="company" required />
    <label>Role</label><input name="role" required />
    <label>Rating (1-5)</label><input type="number" name="rating" min="1" max="5" required />
    <label>Text</label><textarea name="text" rows="3" required></textarea>
    <label>Avatar</label><input type="file" name="avatar" accept="image/*" />
    <div class="actions">
      <button class="btn-primary" id="saveBtn" type="submit">Save</button>
      <button class="btn" type="button" id="cancelBtn">Cancel</button>
    </div>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
  ensureAuth();
  const tbody = document.querySelector("#reviewsTable tbody");
  const modal = document.getElementById("reviewModal");
  const form = document.getElementById("reviewForm");
  const openBtn = document.getElementById("openCreate");
  const cancelBtn = document.getElementById("cancelBtn");
  const modalTitle = document.getElementById("modalTitle");

  async function loadReviews() {
    const res = await authFetch("/reviews?limit=100");
    const data = await res.json();
    tbody.innerHTML = "";
    data.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.company}</td>
        <td>${r.role}</td>
        <td>${r.rating}</td>
        <td class="clip">${r.text}</td>
        <td>${r.avatar ? '<img class="avatar" src="data:image/*;base64,'+r.avatar+'"/>' : ''}</td>
        <td>
          <button class="btn" data-edit="${r.id}">Edit</button>
          <button class="btn-danger" data-del="${r.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openCreate() {
    form.reset();
    form.id.value = "";
    modalTitle.textContent = "Create Review";
    modal.showModal();
  }
  openBtn.onclick = openCreate;
  cancelBtn.onclick = () => modal.close();

  tbody.addEventListener("click", async (e) => {
    const id = e.target.dataset.edit || e.target.dataset.del;
    if (!id) return;

    if (e.target.dataset.edit) {
      const res = await authFetch(`/reviews/${id}`);
      const r = await res.json();
      form.id.value = r.id;
      form.name.value = r.name;
      form.company.value = r.company;
      form.role.value = r.role;
      form.rating.value = r.rating;
      form.text.value = r.text;
      modalTitle.textContent = "Edit Review";
      modal.showModal();
    }

    if (e.target.dataset.del) {
      if (confirm("Delete this review?")) {
        await authFetch(`/reviews/${id}`, { method: "DELETE" });
        loadReviews();
      }
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const id = fd.get("id");
    // when editing without changing file, omit avatar if empty
    if (!fd.get("avatar") || (fd.get("avatar") instanceof File && !fd.get("avatar").name)) {
      fd.delete("avatar");
    }

    const url = id ? `/reviews/${id}` : `/reviews`;
    const method = id ? "PUT" : "POST";

    const res = await authFetch(url, { method, body: fd });
    if (!res.ok) {
      alert("Save failed");
      return;
    }
    modal.close();
    loadReviews();
  });

  loadReviews();
</script>
{% endblock %}
